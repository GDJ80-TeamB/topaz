<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.topaz.mapper.NoticeMapper">

	<!-- 분류 번호: #10 - 공지 사항 삭제 -->
	<delete id="deleteNotice" parameterType="String">
	UPDATE news_notice
	SET 
		use_yn = 'N',
		mod_id = #{modId},
		mod_time = NOW()
	WHERE 
		news_no = #{newsNo};
	</delete>
	<!-- 분류 번호: #10 - 공지 사항 수정 -->
	<update id="updateNotice" parameterType="com.topaz.dto.Notice">
	UPDATE news_notice
	SET 
		title = #{title},
		content = #{content},
		grade = #{grade},
		category = #{category},
		start_date = #{startDate},
		end_date = #{endDate},
		mod_id = #{modId},
		mod_time = NOW()
	WHERE 
		news_no = #{newsNo};	
	</update>
	
	<!-- 분류 번호: #10 - 공지 사항 등록 -->
	<insert id="insertNotice" parameterType="com.topaz.dto.Notice">
	
		INSERT INTO news_notice(
			news_no, 
			title, 
			content, 
			grade, 
			category,
			file_name,
			start_date, 
			end_date, 
			reg_id, 
			reg_time, 
			mod_id, 
			mod_time, 
			use_yn			
		) VALUES (
		    CURRENT_TIMESTAMP(5), 
		    #{title}, 
		    #{content}, 
		    #{grade}, 
		    #{category}, 
		    #{fileName},
		    #{startDate}, 
		    #{endDate}, 
		    #{regId}, 
		    NOW(), 
		    #{modId}, 
		    NOW(), 
		    'Y'		   
		);
	</insert>
	
	<!-- 분류 번호: #10 - 공지 사항 상세 페이지 -->
	<select id="selectNoticeDetail" parameterType="map" resultType="map">
		SELECT
			nn.news_no newsNo, nn.title, nn.content, nn.grade, nn.category, 
			DATE_FORMAT(nn.start_date, '%Y-%m-%d %H:%i:%s') startDate,
			DATE_FORMAT(nn.end_date, '%Y-%m-%d %H:%i:%s') endDate,
			DATE_FORMAT(nn.reg_time, '%Y-%m-%d %H:%i:%s') regTime, 
			DATE_FORMAT(nn.mod_time, '%Y-%m-%d %H:%i:%s') modTime, 
			nn.use_yn useYn, e.emp_name empName
		FROM
			news_notice nn
		JOIN
			employee e 
		ON
			nn.reg_id = e.emp_no	
		WHERE 	
			nn.news_no = #{newsNo}
	
	</select>
	
	<!-- 분류 번호: #10 - 공지 사항 목록 페이지 - 페이징 -->
	<select id="noticeCnt" resultType="int">
		 SELECT
	        COUNT(*) 
	    FROM
	        news_notice AS nn
	    LEFT JOIN
	        common_code AS grade_comm
	    ON
	        nn.grade = grade_comm.cd AND grade_comm.crp_cd = 'W004'
	    LEFT JOIN
	        common_code AS category_comm
	    ON
	        nn.category = category_comm.cd AND category_comm.crp_cd = 'W005'
	    WHERE
	        nn.use_yn = 'Y'
	        AND nn.grade IN (1,2)
	        AND nn.category IN (1,2,3)
	        <if test="noticeType != null and noticeType != ''">
	            AND category_comm.cd_nm = #{noticeType}
	        </if>
	        <if test="searchWord != null and searchWord != ''">
	            AND (nn.title LIKE CONCAT('%', #{searchWord}, '%')
	            OR nn.content LIKE CONCAT('%', #{searchWord}, '%'))
	        </if> 
	</select> 
	
	<!-- 분류 번호: #10 - 공지 사항 목록 페이지 - 리스트 -->
	<select id="selectNoticeList" parameterType="map" resultType="map">
		 SELECT
	        ROW_NUMBER() OVER(ORDER BY nn.news_no DESC) no, 
	        nn.title title,
	        nn.content content,
	        grade_comm.cd_nm grade,
	        category_comm.cd_nm category,
	        nn.reg_time regTime
	    FROM
	        news_notice AS nn
	    LEFT JOIN
	        common_code AS grade_comm
	    ON
	        nn.grade = grade_comm.cd AND grade_comm.crp_cd = 'W004'
	    LEFT JOIN
	        common_code AS category_comm
	    ON
	        nn.category = category_comm.cd AND category_comm.crp_cd = 'W005'
	    WHERE
	        1=1
	        <if test="noticeType != null and noticeType != ''">
	            AND category_comm.cd_nm = #{noticeType}
	        </if>
	        <if test="searchWord != null and searchWord != ''">
	            AND (nn.title LIKE CONCAT('%', #{searchWord}, '%')
	            OR nn.content LIKE CONCAT('%', #{searchWord}, '%'))
	        </if>
	    LIMIT #{currentPage}, #{rowPerPage}
	</select>
</mapper>