<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.topaz.mapper.CleaningMapper">

<!-- 분류번호: #8 - 객실 관리 페이지 : 객실 청소상태 수정 -->
	<update id="updateStatus" parameterType="com.topaz.dto.Cleaning">
	UPDATE 
		cleaning 
	<set>
		<if test="roomStatus != null and roomStatus != ''">
			room_status	= 'C',
		</if>
		mod_time = NOW(),
		mod_id = #{modId}
	</set> 
	WHERE 
		room_no = #{roomNo}
	AND 
		use_yn = 'Y' 
	</update>
	
<!-- 분류번호: #8 - 객실 관리 페이지 : 객실 처어소율 조회 -->
	<select id="selectCleaningRate" resultType="map">
	SELECT 
    	COUNT(CASE WHEN (SELECT cd_nm FROM common_code WHERE crp_cd = 'C002' AND cd = c.room_status) = 'CLEAN' THEN 1 END) cleanRoom,
    	COUNT(*) totalRoom,
    	COUNT(CASE WHEN (SELECT cd_nm FROM common_code WHERE crp_cd = 'C002' AND cd = c.room_status) = 'CLEAN' THEN 1 END) * 100.0 / COUNT(*) cleanRate
	FROM 
	    cleaning c
	JOIN 
	    room r ON c.room_no = r.room_no
	WHERE 
	    r.use_yn = 'Y';
	</select>
</mapper>